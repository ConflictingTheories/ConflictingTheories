# Ecommerce Woes

~ 20231030T210930 ~

It is always enlightening when you discover that you have so-far gone through life without coming across information which you now find yourself in need of. For a large part of this year, I have been grappling with an area which I had never really be required to deal with in-depth -- E-commerce.

Now, let me clarify that I am referring to in-depth e-commerce programming, as opposed to being a consumer or implenter. I have previously implemented e-commerce related elements such as payments, products, subscriptions, and consumable purchases -- but in all these cases I had alway used the native platforms to perform all the reporting. Namely I had used the platform, but never had I tried to report on it.

Recently this year, I have been required to dig into Shopify's platform, but this time, rather than being involved in any kind of "write" operation, I have been tasked solely to focus on reporting. Now while that seems like it would be quite straight forward, it looks like there are a lot of confusing aspects which are not so straightforward to handle. So what is it that makes it difficult you may ask, well let me tell you.

---

### Orders vs Payments vs Sale Transactions

To start off we need to define some terms:

- **Orders**: When a customer comes into your store, adds items to their cart, then performs a checkout - they have placed an order. An order comprises the collection of items or services purchased, shipping, taxes, and any additional fees or tips which may be associated with them.
- **Payments**: When a custom orders something, that is typically tracked separately from the actual transfer of money - sometimes it is handled by a point-of-sale system, credit card, payment provider, crypto, etc, and as such it will need to be accounted for in a third-party ledger which may be outside of the control of the e-commerce platform - so usually, payments are associated, but separate from the underlying order.
- **Sale Transactions**: As part of an order, the customer will usually have one or more items which are 'sold' or possibly a contract for service, but in either case these individual items are considered individual sales. The reason they are tracked separately is because inventory is typically sourced individually, and depending on the particular items, taxes, duties, discounts, etc may be different. In order to properly account for these per-item charges or discounts, they are tracked as individual components within the order. These typically also track shipping costs either broken up across the various items or on a per-item basis. Additionally, if there are manual adjustments, corrections, or edits made to the order over time, they are tracked with additional transactions.

Now that we have those definitions out of the way, we want to highlight some of the tricks to be aware of:

- **Refunds**: First up is one of the most pressing issues that plague ecommerce accounting. Refunds are typically tracked at a future point in time and will always come after the initial order has been placed, but the exact time that they arise is usually dependent on the leniancy of the store itself. This is not such a big issue if you are implementing a single reporting solution for a sole-client - but when you need to generalize your solutions to 1000's of unique stores, you will need to be a bit more flexible in your approach. In general, you cannot assume that a refund cannot come up no matter how long has passed, so you always need to be ready to account for it. Sometimes, a store owner, staff member, or a bug in a system can allow a refund long after the original order is placed - so when you are accounting - you need to be aware of this. Typically, they are tracked as individual sales, but given the complex nature of returns, you may also have refunded taxes, shipping, and need to account for possible duty charges levied - not to mention discounts, and other such scenarios.

- **Adjustments**: Next up, we have adjustments. These occur whenever there is a dispute either with the customer and the store, or after the sale has be completed, and the store notices an error in the record. Sometimes, this is done because of the way the store handled a complaint, or may have processed the refund as a manual override. These typically are tracked as transactions, but they may not necessarily have a consistent pattern as they can be manually added. It is difficult to track these and usually they need to be classified into various situational categories. While this may not cover the 'reality' of the situation, it can allow you at least handle them programmatically.

- **Taxes**: I would say that taxes are loathed by almost every person alive. And they do not disappoint here either. Taxes bring with them all sorts of tricks and gotchas. They can be included in the base price and then subtracted out post-sale - meaning that the gross and subtotal may have the taxes included in their values. Additionally, other stores will choose to forgo the inclusion and explicityly have their prices before tax, and then apply the taxes as separate items. These may be regional, item specific, and in some cases can be tailored for specific orders. All of this variation means you need to be flexible in how you account for the taxes. My approach albeit not graceful, was to account for each of these situations independently as separate columns of data. Each total was provide with before- and after- tax versions as well as including a dynamic total which would handle row-by-row variations.

- **Shipping**: While not nearly as tricky as taxes, shipping can provide some additional challenges. Shipping is usually separate and comprises its own entries within the order, however, it can also have its own taxes and discounts as well. Some items may have per-item shipping, while others may have flat-rates on their orders. Additionally, shipments may be broken up into multiple packages with multiple carriers which can result in different costs, discounts, and various other related elements such as duties or additional handling fees. These are usually tracked as transactional items and will be associated with the main order.

---

### Lifecyles vs Events vs Snapshots

To top it all off, we tend to find ourselves asking different questions about the same data and arriving at different results, but not necessarily realizing the different assumtions and biases we have implicitly adopted that led to them:

- **Orders have Lifecycles**: When dealing with ecommerce, we need to realize that an order does not just exist at a single point in time. They tend to have many associated dates of importantance - the creation date, the processing date, the refund date, the cancellation date, the modification date, etc... In fact, it may not be too bold to say that an order is created indefinitely and that it must be willingly voided or destroyed in some fashion to cease existing. Once an order is created, it lives until the order is effectively nullified. But that does not necessarily mean that anything changes. For most businesses will have a limited window that they typically honor refunds or exchanges, and after that period of time, they will consider the sale final. Once the sale is considered final - conceptually - you can then generalize the order, but even then, in theory it may still change one day however unlikely. This concept of lifecycles is very important. For it is easy enough to consider the present moment as the 'truth' but tomorrow, next week, next year, will that truth still be true? The problem with its mutable nature is that it can change and you will need to update when it does.

- **Sales are events**: Conversely, sales themselves are typically tied to a single point in time and usually **happen** at some point in time. They can be considered events and while more may occur in the future and you cannot necessarily predict when the next will arive until it does, you can log them down and track them. Now, it is possible that they can have a couple times associated with them (processing, creation, last referenced, etc) - but these usually will not change once set, and will usually act an appended-ledger as opposed to a mutable one. This immutable nature is in stark contrast to the nature of the order. Due to the nature of events, you can typically slice between them - exclude some of them, or expand to include more. Unlike orders you rarely need to worry about tracking them over ranges of time and as such they are good granular data to reference for the order and can provide a means of calculating different snapshots through time.

- **Reports are snapshots**: When you go to report on a period of time, a collection of orders, a particular production, promotion, or customer demographic, you will normally have a snapshot. This is important to recognize. A snapshot is inherently going to have some caveats and will struggle to fully articulate everything that is happening. A report is framed within a set of assumptions - and if those assumptions are forgotten about, then misunderstanding can arise. When looking at orders, it is imperative that you decide on how you going to approach the order's lifecycle. If you are reporting on the past (which is usually the case with reports - especially ones which have sat around collecting bits) then you will need to be aware of how your order lifecycles are being reported on. Usually consistency is the first thing you need to maintain, but it is also important that you be aware of the subtle contexts involved with orders. Are you interested in its **current adjusted values** which take into account all the refunds, edits, and in theory represents the order **as it is right now (not necessarily when the old report was made)** because that value can shift based on the present meaning of **now**. Another way to look at the order is the **original unadjusted values** which would ignore all the reunfs, edits, etc and would look at the orders as they were when they were placed at the checkout - with this situation you are more interested in what the orders were that people were say buying before they had disputes, refunded things, etc. This second situation would typically remain static through time as you would not expect to see any changes as it would be considering only the original values. There is another common situation that arises, and that is to look as **what the order _\_was\__ at a particular moment in time**. This would restric the boundary of the order's life-cycle to that of desired range and may not represent either the original nor the current values, but rather reflect the nature of the order a particular moment in time. This type of snapshot would retain over time, but would not necessarily be reflective of the current reality.

---

### Context Switching
The truth is there is no panacea which will provide all the necessary context in one single report. Usually you need to be aware of the different scenarios and handle them accordingly. For example - if one were to measure the success of their advertising promotions, track weekly sales, chart product stickiness, they would likely need to consider the context of their data and make sure that they were applying the correct assumptions. I am sure there is a best practice for each situation and I will hopefully get more knowledge and experience of my own in this area in the future, but right now I will just generalize it is a bit and say that tracking promotions would most likely require either the moment in time or the original order where as if you are tracking product stickiness and general best-sellers, you would likely need to be more cognizant of the current order values because you want to see how much had churned. All in all, context switch and awareness are paramount to leveraging the data and reporting on it successfully. When dealing with so many clients however, finding a one-size-fits-all solution is almost impossible. Many people may wish to apply different contexts when analysing that data - so you are put into a choice. Do you restrict the options to provide a little more simplicity at the cost of flexibility, or do you provide them the ability to filter and tweak the context as needed with the added complexity and risk that they may be misapplying them? These are questions I cannot answer, but I think they are important to consider when working with large general-purpose ecommerce data.

---

### Conclusion
This post was not meant to be exhaustive by any means. I have barely scratched the surface of complexities that can and do arise in the ecommerce space, but I have tried to focus more on some of the more generic issues at play. Rather than worrying about specific tax laws, duties, currencies (yes I left it out, and while it is a pain - it probably deserves its own post entirely - I also didn't mention timezones in this post and they most certainly rear their ugly-heads up - all those times....where again is that store located....but I digress). Ecommerce is just another one of those areas in programming which in theory is all nice and simple until you actually have to do the thing...

PS: I will try to add some diagrams one day if I get a chance. There are lots of ways to better articulate some of these concepts with imagary.